name: UI-Act Tests

on:
  workflow_dispatch:

jobs:

  create-vm:
    runs-on: ubuntu-latest
    steps:
      - name: Clone template VM
        id: clone
        run: |
          VMID=$((2000 + RANDOM % 1000))
          NAME=gha-${{ github.run_id }}
          curl -vkf -X POST "https://norlund.mine.nu:8006/api2/json/nodes/alix/qemu/114/clone" \
            -H 'Authorization: PVEAPIToken=gha@pve!gha-token=${{ secrets.PVE_TOKEN }}' \
            -d "newid=$VMID" \
            -d "name=$NAME" \
            -d "target=alix"
          sleep 5
          echo "vmid=$VMID" >> $GITHUB_OUTPUT
      - name: Start VM
        run: |
          curl -vkf -X POST "https://norlund.mine.nu:8006/api2/json/nodes/alix/qemu/200/status/start" \
            -H 'Authorization: PVEAPIToken=gha@pve!gha-token=${{ secrets.PVE_TOKEN }}'
      - name: Wait for runner to connect
        run: |
          echo "Waiting for GitHub runner..."
          for i in {1..30}; do
            RUNNERS=$(gh api repos/${{ github.repository }}/actions/runners \
              -q '.runners[].name')
            echo "Currently registered: $RUNNERS"
            if echo "$RUNNERS" | grep -q "gha-${{ github.run_id }}"; then
              echo "Runner connected!"
              exit 0
            fi
            sleep 10
          done
          echo "Runner did not connect in time" >&2
          exit 1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            
    outputs:
      vmid: ${{ steps.clone.outputs.vmid }}

  run-tests:
    runs-on: proxmox
    steps:
      - uses: actions/checkout@v4
      # Build deb package
      - run: make package
      # Install deb
      - run: sudo apt install ./ui-act_*.deb
      # Restart gnome before the extension can be enabled (sleep for gdm to restart properly)
      - run: sudo systemctl restart gdm3 && sleep 60 && gnome-extensions enable ui-act@tobiasnorlund.github.com
      # Set api key and disable telemetry
      - run: gsettings --schemadir /usr/share/gnome-shell/extensions/ui-act@tobiasnorlund.github.com/schemas set org.gnome.shell.extensions.ui-act telemetry-enabled false
      - run: gsettings --schemadir /usr/share/gnome-shell/extensions/ui-act@tobiasnorlund.github.com/schemas set org.gnome.shell.extensions.ui-act anthropic-api-key ${{ secrets.ANTHROPIC_API_KEY }}
      # Start a calculator and launch UI-Act on it (for some reason gnome-calculator opens very slowly sometimes)
      - run: gnome-calculator & sleep 30
      - run: xdotool key ctrl+space && sleep 2 && xdotool type 'Calculate 3+4' && sleep 1
      # Save launcher screenshot before kicking off
      - run: scrot launcher-screen.png
      - uses: actions/upload-artifact@v4
        with:
          name: ui-act-launcher-screen
          path: launcher-screen.png
      # Hit enter to kick off agent, wait 30s and take screenshot to inspect result
      - run: xdotool key Return && sleep 30 && scrot result-screen.png && sleep 1
      - uses: actions/upload-artifact@v4
        with:
          name: result-screen
          path: result-screen.png
