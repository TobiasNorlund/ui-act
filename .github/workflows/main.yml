name: UI-Act Tests

on:
  workflow_dispatch:

jobs:
  run-tests:
    runs-on: proxmox
    steps:
      - uses: actions/checkout@v4
      # Build deb package
      - run: make package
      # Install deb
      - run: sudo apt install ./ui-act_*.deb
      # Restart gnome before the extension can be enabled
      - run: sudo systemctl restart gdm3 && gnome-extensions enable ui-act@tobiasnorlund.github.com
      # Set api key and disable telemetry
      - run: gsettings --schemadir /usr/share/gnome-shell/extensions/ui-act@tobiasnorlund.github.com/schemas set org.gnome.shell.extensions.ui-act telemetry-enabled false
      - run: gsettings --schemadir /usr/share/gnome-shell/extensions/ui-act@tobiasnorlund.github.com/schemas set org.gnome.shell.extensions.ui-act anthropic-api-key ${{ secrets.ANTHROPIC_API_KEY }}
      # Start a calculator and launch UI-Act on it
      - run: DISPLAY=:0 gnome-calculator & sleep 30
      - run: DISPLAY=:0 xdotool key ctrl+space && sleep 2 && DISPLAY=:0 xdotool type 'Calculate 3+4'
      # Save screenshot
      - run: DISPLAY=:0 scrot screen.png
      - uses: actions/upload-artifact@v4
        with:
          name: ui-act-launcher-screen
          path: screen.png
      - run: DISPLAY=:0 xdotool key Return && sleep 30 && DISPLAY=:0 scrot screen.png
      - uses: actions/upload-artifact@v4
        with:
          name: result-screen
          path: screen.png
